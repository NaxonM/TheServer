
<!DOCTYPE html>
<html lang="en" class="h-full bg-slate-100">
<head>
    <meta charset="UTF-8">
    <title>Pandora's Box - File Proxy System</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body class="h-full">
    <div class="min-h-full">
        <!-- Header -->
        <header class="bg-white shadow-sm">
            <div class="mx-auto max-w-7xl py-4 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
                <h1 class="text-xl font-bold tracking-tight text-slate-900">File Proxy Dashboard</h1>
                <div>
                    <a href="{{ url_for('main.dashboard') }}" class="text-sm font-medium text-slate-600 hover:text-purple-600">Dashboard</a>
                    {% if current_user.is_admin %}
                        <a href="/admin" class="ml-4 text-sm font-medium text-slate-600 hover:text-purple-600">Admin Panel</a>
                        <a href="{{ url_for('pandora_box.index') }}" class="ml-4 text-sm font-medium text-purple-600 font-bold">Pandora's Box</a>
                    {% endif %}
                    <a href="/logout" class="ml-4 text-sm font-medium text-slate-600 hover:text-purple-600">Logout</a>
                </div>
            </div>
        </header>
        <main class="mx-auto max-w-7xl py-8 px-4 sm:px-6 lg:px-8" x-data="pornFetchPage()">
            <!-- Flashed messages -->
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    <div class="rounded-md bg-blue-50 p-4 mb-8">
                        <div class="flex">
                            <div class="ml-3">
                                {% for category, message in messages %}
                                    <p class="text-sm font-medium text-{{ 'red' if category == 'danger' else 'blue' }}-800">{{ message }}</p>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                {% endif %}
            {% endwith %}

            <!-- Main content grid -->
            <div class="grid grid-cols-1 items-start gap-8" x-data="{ activeTab: 'url' }">
                <div class="space-y-8">
                    <!-- Downloader Form -->
                    <section class="bg-white shadow-sm ring-1 ring-slate-900/5 rounded-lg">
                        <header class="p-4 sm:px-6 border-b border-slate-200">
                            <h2 class="text-lg font-medium leading-6 text-slate-900">Pandora's Box ðŸ˜ˆ</h2>
                            <nav class="mt-2 -mb-px flex space-x-8">
                                <a href="#" @click.prevent="activeTab = 'url'" :class="{'border-purple-500 text-purple-600': activeTab === 'url', 'border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300': activeTab !== 'url'}" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Single URL</a>
                                <a href="#" @click.prevent="activeTab = 'model'" :class="{'border-purple-500 text-purple-600': activeTab === 'model', 'border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300': activeTab !== 'model'}" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Model/Creator</a>
                                <a href="#" @click.prevent="activeTab = 'playlist'" :class="{'border-purple-500 text-purple-600': activeTab === 'playlist', 'border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300': activeTab !== 'playlist'}" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Playlist</a>
                                <a href="#" @click.prevent="activeTab = 'search'" :class="{'border-purple-500 text-purple-600': activeTab === 'search', 'border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300': activeTab !== 'search'}" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Search</a>
                                <a href="#" @click.prevent="activeTab = 'manager'" :class="{'border-purple-500 text-purple-600': activeTab === 'manager', 'border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300': activeTab !== 'manager'}" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Model Manager</a>
                                <a href="#" @click.prevent="activeTab = 'file'" :class="{'border-purple-500 text-purple-600': activeTab === 'file', 'border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300': activeTab !== 'file'}" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Process File</a>
                                <a href="#" @click.prevent="activeTab = 'settings'" :class="{'border-purple-500 text-purple-600': activeTab === 'settings', 'border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300': activeTab !== 'settings'}" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Settings</a>
                            </nav>
                        </header>

                        <div class="p-4 sm:px-6 text-sm text-slate-500 bg-slate-50/50">
                            <p><span class="font-semibold">Supported Model/Creator sites:</span> Pornhub, XVideos, XNXX, Eporner, HQPorner, MissAV, xHamster, SpankBang, YouPorn.</p>
                            <p><span class="font-semibold">Supported Playlist sites:</span> PornHub.</p>
                        </div>

                        <!-- Interactive Single URL Form -->
                        <div x-show="activeTab === 'url'" class="p-4 sm:px-6 space-y-4">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                            <!-- URL Input -->
                            <div x-show="!videoInfo" class="space-y-4">
                                <div>
                                    <label for="interactive_query_url" class="block text-sm font-medium text-slate-700">Video URL</label>
                                    <div class="mt-1 flex space-x-2">
                                        <input type="url" id="interactive_query_url" placeholder="Enter a video URL to fetch its info" class="flex-grow p-3 border rounded-md shadow-sm border-slate-300">
                                        <button @click="getVideoInfo()" :disabled="isLoading" class="rounded-md bg-purple-600 px-4 py-3 text-sm font-semibold text-white shadow-sm hover:bg-purple-500 disabled:opacity-50">
                                            <span x-show="!isLoading">Fetch Info</span>
                                            <span x-show="isLoading">Fetching...</span>
                                        </button>
                                        <button @click="document.getElementById('interactive_query_url').value = ''" type="button" class="rounded-md bg-slate-200 px-4 py-3 text-sm font-semibold text-slate-700 shadow-sm hover:bg-slate-300">Clear</button>
                                    </div>
                                </div>
                            </div>

                            <!-- Video Info Display -->
                            <div x-show="videoInfo" class="space-y-4 p-4 border border-slate-200 rounded-lg bg-slate-50">
                                <div class="flex items-start space-x-4">
                                    <img :src="videoInfo.thumbnail" x-show="videoInfo.thumbnail" class="h-24 w-40 object-cover rounded-md bg-slate-200 flex-shrink-0" referrerpolicy="no-referrer">
                                    <div x-show="!videoInfo.thumbnail" class="h-24 w-40 rounded-md bg-slate-200 flex items-center justify-center text-xs text-slate-400 flex-shrink-0">No Thumbnail</div>
                                    <div class="flex-grow">
                                        <h3 class="text-lg font-medium text-slate-900" x-text="videoInfo.title"></h3>
                                        <div class="mt-1 text-sm text-slate-600 space-y-1">
                                            <p x-show="videoInfo.author"><span class="font-semibold">By:</span> <span x-text="videoInfo.author"></span></p>
                                            <p x-show="videoInfo.length"><span class="font-semibold">Length:</span> <span x-text="formatDuration(videoInfo.length)"></span></p>
                                            <p x-show="videoInfo.publish_date"><span class="font-semibold">Published:</span> <span x-text="formatDate(videoInfo.publish_date)"></span></p>
                                        </div>
                                        <div class="mt-2" x-show="videoInfo.tags && videoInfo.tags.length > 0">
                                            <p class="text-xs font-semibold text-slate-700">Tags:</p>
                                            <template x-for="tag in (Array.isArray(videoInfo.tags) ? videoInfo.tags.slice(0, 8) : videoInfo.tags.split(',').slice(0, 8))" :key="tag">
                                                <span class="inline-flex items-center rounded-full bg-slate-200 px-2 py-0.5 text-xs font-medium text-slate-700 m-0.5" x-text="tag.trim()"></span>
                                            </template>
                                        </div>
                                    </div>
                                </div>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 items-end">
                                    <div>
                                        <label for="interactive_quality_url" class="block text-sm font-medium text-slate-700">Available Quality</label>
                                        <select id="interactive_quality_url" class="mt-1 w-full p-3 border rounded-md shadow-sm border-slate-300">
                                            <template x-for="quality in videoInfo.qualities" :key="quality">
                                                <option :value="quality" x-text="quality"></option>
                                            </template>
                                        </select>
                                    </div>
                                    <div class="flex space-x-2">
                                        <button @click="submitBatchDownload([videoInfo.url], 'interactive_quality_url')" :disabled="isSaving" class="w-full rounded-md bg-green-600 px-4 py-3 text-sm font-semibold text-white shadow-sm hover:bg-green-500 disabled:opacity-50">
                                            <span x-show="!isSaving">Download</span>
                                            <span x-show="isSaving">Requesting...</span>
                                        </button>
                                        <button @click="clearVideoInfo()" class="w-full rounded-md bg-slate-200 px-4 py-3 text-sm font-semibold text-slate-700 shadow-sm hover:bg-slate-300">Clear</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Model/Creator Form -->
                        <div x-show="activeTab === 'model'" class="p-4 sm:px-6 space-y-4">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                            <div>
                                <label for="query_model" class="block text-sm font-medium text-slate-700">Model/Creator URL</label>
                                <div class="mt-1"><input type="url" id="query_model" class="w-full p-3 border rounded-md shadow-sm border-slate-300" required></div>
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div>
                                    <label for="limit_model" class="block text-sm font-medium text-slate-700">Result Limit</label>
                                    <div class="mt-1"><input type="number" id="limit_model" value="50" min="1" max="1000" class="w-full p-3 border rounded-md shadow-sm border-slate-300" required></div>
                                </div>
                                <div>
                                    <label for="delay_model" class="block text-sm font-medium text-slate-700">Request Delay (s)</label>
                                    <div class="mt-1"><input type="number" id="delay_model" value="1" min="0" max="10" step="0.1" class="w-full p-3 border rounded-md shadow-sm border-slate-300" required></div>
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <button @click.prevent="fetchVideos('model')" :disabled="isLoading" class="rounded-md bg-purple-600 px-4 py-3 text-sm font-semibold text-white shadow-sm hover:bg-purple-500 disabled:opacity-50">
                                    <span x-show="!isLoading">Fetch Videos</span>
                                    <span x-show="isLoading">Fetching...</span>
                                </button>
                                <button @click.prevent="fetchAndDownloadAll('model')" :disabled="isLoading" class="rounded-md bg-green-600 px-4 py-3 text-sm font-semibold text-white shadow-sm hover:bg-green-500 disabled:opacity-50">
                                    <span x-show="!isLoading">Fetch & Download All</span>
                                    <span x-show="isLoading">Working...</span>
                                </button>
                            </div>
                        </div>

                        <!-- Playlist Form -->
                        <div x-show="activeTab === 'playlist'" class="p-4 sm:px-6 space-y-4">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                            <div>
                                <label for="query_playlist" class="block text-sm font-medium text-slate-700">PornHub Playlist URL</label>
                                <div class="mt-1"><input type="url" id="query_playlist" class="w-full p-3 border rounded-md shadow-sm border-slate-300" required></div>
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div>
                                    <label for="limit_playlist" class="block text-sm font-medium text-slate-700">Result Limit</label>
                                    <div class="mt-1"><input type="number" id="limit_playlist" value="50" min="1" max="1000" class="w-full p-3 border rounded-md shadow-sm border-slate-300" required></div>
                                </div>
                                <div>
                                    <label for="delay_playlist" class="block text-sm font-medium text-slate-700">Request Delay (s)</label>
                                    <div class="mt-1"><input type="number" id="delay_playlist" value="1" min="0" max="10" step="0.1" class="w-full p-3 border rounded-md shadow-sm border-slate-300" required></div>
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <button @click.prevent="fetchVideos('playlist')" :disabled="isLoading" class="rounded-md bg-purple-600 px-4 py-3 text-sm font-semibold text-white shadow-sm hover:bg-purple-500 disabled:opacity-50">
                                    <span x-show="!isLoading">Fetch Videos</span>
                                    <span x-show="isLoading">Fetching...</span>
                                </button>
                                <button @click.prevent="fetchAndDownloadAll('playlist')" :disabled="isLoading" class="rounded-md bg-green-600 px-4 py-3 text-sm font-semibold text-white shadow-sm hover:bg-green-500 disabled:opacity-50">
                                    <span x-show="!isLoading">Fetch & Download All</span>
                                    <span x-show="isLoading">Working...</span>
                                </button>
                            </div>
                        </div>

                        <!-- Search Form -->
                        <div x-show="activeTab === 'search'" class="p-4 sm:px-6 space-y-4">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                            <div>
                                <label for="query_search" class="block text-sm font-medium text-slate-700">Search Query</label>
                                <div class="mt-1"><input type="text" id="query_search" class="w-full p-3 border rounded-md shadow-sm border-slate-300" required></div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700">Search Providers</label>
                                <div class="mt-2 grid grid-cols-2 sm:grid-cols-4 gap-4">
                                    <label class="flex items-center space-x-2"><input type="checkbox" name="providers" value="pornhub" checked class="rounded border-slate-300 text-purple-600 shadow-sm focus:ring-purple-500"><span>PornHub</span></label>
                                    <label class="flex items-center space-x-2"><input type="checkbox" name="providers" value="xvideos" checked class="rounded border-slate-300 text-purple-600 shadow-sm focus:ring-purple-500"><span>XVideos</span></label>
                                    <label class="flex items-center space-x-2"><input type="checkbox" name="providers" value="xnxx" checked class="rounded border-slate-300 text-purple-600 shadow-sm focus:ring-purple-500"><span>XNXX</span></label>
                                    <label class="flex items-center space-x-2"><input type="checkbox" name="providers" value="eporner" checked class="rounded border-slate-300 text-purple-600 shadow-sm focus:ring-purple-500"><span>Eporner</span></label>
                                    <label class="flex items-center space-x-2"><input type="checkbox" name="providers" value="hqporner" class="rounded border-slate-300 text-purple-600 shadow-sm focus:ring-purple-500"><span>HQPorner</span></label>
                                    <label class="flex items-center space-x-2"><input type="checkbox" name="providers" value="missav" class="rounded border-slate-300 text-purple-600 shadow-sm focus:ring-purple-500"><span>MissAV</span></label>
                                    <label class="flex items-center space-x-2"><input type="checkbox" name="providers" value="xhamster" class="rounded border-slate-300 text-purple-600 shadow-sm focus:ring-purple-500"><span>xHamster</span></label>
                                    <label class="flex items-center space-x-2"><input type="checkbox" name="providers" value="spankbang" class="rounded border-slate-300 text-purple-600 shadow-sm focus:ring-purple-500"><span>SpankBang</span></label>
                                    <label class="flex items-center space-x-2"><input type="checkbox" name="providers" value="youporn" class="rounded border-slate-300 text-purple-600 shadow-sm focus:ring-purple-500"><span>YouPorn</span></label>
                                </div>
                                <p class="mt-2 text-xs text-slate-500">Note: SpankBang may fail due to bot protection; use VPN if needed.</p>
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div>
                                    <label for="limit_search" class="block text-sm font-medium text-slate-700">Result Limit</label>
                                    <div class="mt-1"><input type="number" id="limit_search" value="50" min="1" max="200" class="w-full p-3 border rounded-md shadow-sm border-slate-300" required></div>
                                </div>
                                <div>
                                    <label for="delay_search" class="block text-sm font-medium text-slate-700">Request Delay (s)</label>
                                    <div class="mt-1"><input type="number" id="delay_search" value="1" min="0" max="10" step="0.1" class="w-full p-3 border rounded-md shadow-sm border-slate-300" required></div>
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <button @click.prevent="fetchVideos('search')" :disabled="isLoading" class="rounded-md bg-purple-600 px-4 py-3 text-sm font-semibold text-white shadow-sm hover:bg-purple-500 disabled:opacity-50">
                                    <span x-show="!isLoading">Fetch Videos</span>
                                    <span x-show="isLoading">Fetching...</span>
                                </button>
                                <button @click.prevent="fetchAndDownloadAll('search')" :disabled="isLoading" class="rounded-md bg-green-600 px-4 py-3 text-sm font-semibold text-white shadow-sm hover:bg-green-500 disabled:opacity-50">
                                    <span x-show="!isLoading">Fetch & Download All</span>
                                    <span x-show="isLoading">Working...</span>
                                </button>
                            </div>
                        </div>

                        <!-- Model Manager -->
                        <div x-show="activeTab === 'manager'" class="p-4 sm:px-6 space-y-6" x-data="modelManagerPage()">
                            <div>
                                <label for="new_model_url" class="block text-sm font-medium text-slate-700">Add New Model URL</label>
                                <div class="mt-1 flex space-x-2">
                                    <input type="url" id="new_model_url" placeholder="Enter a supported model/creator URL" class="flex-grow p-3 border rounded-md shadow-sm border-slate-300">
                                    <button @click="addModel()" :disabled="isLoading" class="rounded-md bg-purple-600 px-4 py-3 text-sm font-semibold text-white shadow-sm hover:bg-purple-500 disabled:opacity-50">
                                        <span x-show="!isLoading">Add Model</span>
                                        <span x-show="isLoading">Adding...</span>
                                    </button>
                                </div>
                            </div>
                            <div class="space-y-4">
                                <div class="flex justify-between items-center border-b border-slate-200 pb-2">
                                    <h3 class="text-md font-medium text-slate-800">Tracked Models</h3>
                                    <button @click="checkAllModelsForUpdates()" :disabled="isLoading || trackedModels.length === 0" class="rounded-md bg-blue-600 px-3 py-2 text-xs font-semibold text-white shadow-sm hover:bg-blue-500 disabled:opacity-50">
                                        <span x-show="!isLoading">Check All for Updates</span>
                                        <span x-show="isLoading">Checking...</span>
                                    </button>
                                </div>
                                <ul class="divide-y divide-slate-200">
                                    <template x-for="model in trackedModels" :key="model">
                                        <li class="py-3 flex items-center justify-between">
                                            <p class="text-sm font-mono text-slate-700 truncate" x-text="model"></p>
                                            <div class="flex space-x-2 flex-shrink-0">
                                                <button @click="checkForUpdates(model)" :disabled="isLoading" class="rounded-md bg-blue-600 px-3 py-2 text-xs font-semibold text-white shadow-sm hover:bg-blue-500 disabled:opacity-50">
                                                    <span x-show="!isLoading">Check for Updates</span>
                                                    <span x-show="isLoading">Checking...</span>
                                                </button>
                                                <button @click="removeModel(model)" :disabled="isLoading" class="rounded-md bg-red-600 px-3 py-2 text-xs font-semibold text-white shadow-sm hover:bg-red-500 disabled:opacity-50">Remove</button>
                                            </div>
                                        </li>
                                    </template>
                                    <template x-if="trackedModels.length === 0">
                                        <li class="py-4 text-center text-sm text-slate-500">No models are being tracked yet.</li>
                                    </template>
                                </ul>
                            </div>
                        </div>

                        <!-- Process File Form -->
                        <div x-show="activeTab === 'file'" class="p-4 sm:px-6 space-y-4">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                            <div>
                                <label for="url_list" class="block text-sm font-medium text-slate-700">Video URLs (one per line)</label>
                                <div class="mt-1">
                                    <textarea id="url_list" rows="10" class="w-full p-3 border rounded-md shadow-sm border-slate-300" required></textarea>
                                </div>
                                <p class="mt-2 text-xs text-slate-500">Paste a list of video URLs to download them in a batch.</p>
                            </div>
                                <div class="mt-1">
                                    <select id="quality_file" class="w-full p-3 border rounded-md shadow-sm border-slate-300">
                                        <option value="best" selected>Best (Highest)</option>
                                        <option value="1080p">1080p</option>
                                        <option value="720p">720p</option>
                                        <option value="480p">480p</option>
                                        <option value="360p">360p (Lowest)</option>
                                    </select>
                                </div>
                                <p class="mt-2 text-xs text-slate-500">Note: For batch processing from a file, specific qualities for each URL are not fetched beforehand. The downloader will attempt to find the selected quality and fall back to the nearest available if it's not found.</p>
                            </div>
                            <div><button @click.prevent="submitBatchDownload(document.getElementById('url_list').value.split('\n'), 'quality_file')" :disabled="isSaving" class="rounded-md bg-purple-600 px-4 py-3 text-sm font-semibold text-white shadow-sm hover:bg-purple-500 disabled:opacity-50">
                                <span x-show="!isSaving">Process and Download</span>
                                <span x-show="isSaving">Requesting...</span>
                            </button></div>
                        </div>

                        <!-- Settings Form -->
                        <div x-show="activeTab === 'settings'" class="p-4 sm:px-6 space-y-6" x-data="settingsPage()">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <!-- Performance Settings -->
                                <div class="space-y-4">
                                    <h3 class="text-md font-medium text-slate-800 border-b border-slate-200 pb-2">Performance</h3>
                                    <div>
                                        <label for="workers" class="block text-sm font-medium text-slate-700">Workers</label>
                                        <input type="number" id="workers" x-model="settings.workers" class="mt-1 w-full p-3 border rounded-md shadow-sm border-slate-300">
                                    </div>
                                    <div>
                                        <label for="retries" class="block text-sm font-medium text-slate-700">Max Retries</label>
                                        <input type="number" id="retries" x-model="settings.retries" class="mt-1 w-full p-3 border rounded-md shadow-sm border-slate-300">
                                    </div>
                                    <div>
                                        <label for="timeout" class="block text-sm font-medium text-slate-700">Timeout (seconds)</label>
                                        <input type="number" id="timeout" x-model="settings.timeout" class="mt-1 w-full p-3 border rounded-md shadow-sm border-slate-300">
                                    </div>
                                    <div>
                                        <label for="threading_mode" class="block text-sm font-medium text-slate-700">Threading Mode</label>
                                        <select id="threading_mode" x-model="settings.threading_mode" class="mt-1 w-full p-3 border rounded-md shadow-sm border-slate-300">
                                            <option value="threaded">Threaded</option>
                                            <option value="default">Default</option>
                                            <option value="ffmpeg">FFmpeg (Requires FFmpeg in PATH)</option>
                                        </select>
                                    </div>
                                </div>
                                <!-- Directory & Network Settings -->
                                <div class="space-y-4">
                                    <h3 class="text-md font-medium text-slate-800 border-b border-slate-200 pb-2">Directory & Network</h3>
                                    <div>
                                        <label for="proxy" class="block text-sm font-medium text-slate-700">Proxy URL (e.g., socks5://user:pass@host:port)</label>
                                        <input type="text" id="proxy" x-model="settings.proxy" placeholder="Leave blank to disable" class="mt-1 w-full p-3 border rounded-md shadow-sm border-slate-300">
                                    </div>
                                    <div class="space-y-4">
                                        <div class="flex items-start">
                                            <input type="checkbox" id="directory_system" x-model="settings.directory_system" class="h-4 w-4 rounded border-slate-300 text-purple-600 focus:ring-purple-500 mt-1">
                                            <label for="directory_system" class="ml-2 block text-sm text-slate-900">Enable Directory System (Save files in author-named folders)</label>
                                        </div>
                                        <div class="flex items-start">
                                            <input type="checkbox" id="ignore_errors" x-model="settings.ignore_errors" class="h-4 w-4 rounded border-slate-300 text-purple-600 focus:ring-purple-500 mt-1">
                                            <label for="ignore_errors" class="ml-2 block text-sm text-slate-900">Ignore errors during batch downloads <span class="text-xs text-slate-500">(equivalent to CLI `--ignore_errors`)</span></label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="pt-4 flex justify-end">
                                <button @click.prevent="saveSettings" :disabled="isSaving" class="rounded-md bg-purple-600 px-4 py-3 text-sm font-semibold text-white shadow-sm hover:bg-purple-500 disabled:opacity-50">
                                    <span x-show="!isSaving">Save Settings</span>
                                    <span x-show="isSaving">Saving...</span>
                                </button>
                            </div>
                        </div>
                    </section>

                    <!-- Fetched Videos Section -->
                    <section x-show="fetchedVideos.length > 0" class="bg-white shadow-sm ring-1 ring-slate-900/5 rounded-lg" style="display: none;">
                        <header class="p-4 sm:px-6 border-b border-slate-200 flex justify-between items-center">
                            <h2 class="text-lg font-medium leading-6 text-slate-900">Fetched Videos</h2>
                            <div>
                                <button @click="clearFetchedVideos()" class="text-sm font-medium text-slate-600 hover:text-purple-600">Clear</button>
                            </div>
                        </header>
                        <div class="p-4 sm:px-6 space-y-4">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-4">
                                    <input type="checkbox" @change="toggleSelectAll($event.target.checked)" :checked="selectedVideos.length === fetchedVideos.length && fetchedVideos.length > 0" class="rounded border-slate-300 text-purple-600 shadow-sm focus:ring-purple-500">
                                    <label class="text-sm font-medium text-slate-700">Select All</label>
                                </div>
                            </div>
                            <div class="max-h-96 overflow-y-auto border border-slate-200 rounded-md">
                                <template x-for="(video, index) in fetchedVideos" :key="index">
                                    <label class="flex items-start space-x-4 p-3 hover:bg-slate-50 cursor-pointer border-b border-slate-100">
                                        <input type="checkbox" :value="video.url" x-model="selectedVideos" class="rounded border-slate-300 text-purple-600 shadow-sm focus:ring-purple-500 mt-1">
                                        <img :src="video.thumbnail" x-show="video.thumbnail" class="h-16 w-28 object-cover rounded-md bg-slate-200 flex-shrink-0" referrerpolicy="no-referrer">
                                        <div x-show="!video.thumbnail" class="h-16 w-28 rounded-md bg-slate-200 flex items-center justify-center text-xs text-slate-400 flex-shrink-0">No Thumb</div>
                                        <div class="flex-grow">
                                            <p class="text-sm font-medium text-slate-800" x-text="video.title"></p>
                                            <p class="text-xs text-slate-500 mt-0.5">
                                                <span x-show="video.author" x-text="`By: ${video.author}`"></span>
                                                <span x-show="video.length" x-text="` | ${formatDuration(video.length)}`"></span>
                                                <span x-show="video.publish_date" x-text="` | ${formatDate(video.publish_date)}`"></span>
                                            </p>
                                        </div>
                                    </label>
                                </template>
                            </div>
                        </div>
                        <div class="p-4 sm:px-6 border-t border-slate-200 flex items-center justify-between">
                            <div>
                                <label for="quality_batch" class="block text-sm font-medium text-slate-700">Video Quality</label>
                                <div class="mt-1">
                                    <select id="quality_batch" class="w-full p-3 border rounded-md shadow-sm border-slate-300" :disabled="batchQualities.length === 0">
                                        <template x-for="quality in batchQualities" :key="quality"><option :value="quality" x-text="quality"></option></template>
                                    </select>
                                </div>
                            </div>
                            <button @click.prevent="submitBatchDownload(selectedVideos, 'quality_batch')" :disabled="selectedVideos.length === 0 || isSaving" class="self-end rounded-md bg-purple-600 px-4 py-3 text-sm font-semibold text-white shadow-sm hover:bg-purple-500 disabled:opacity-50">
                                <span x-show="!isSaving">Download Selected (<span x-text="selectedVideos.length"></span>)</span>
                                <span x-show="isSaving">Requesting...</span>
                            </button>
                        </div>
                    </section>

                    <!-- Active Downloads Section -->
                    <section class="bg-white shadow-sm ring-1 ring-slate-900/5 rounded-lg">
                        <header class="p-4 sm:px-6"><h2 class="text-lg font-medium leading-6 text-slate-900">Unboxing...</h2></header>
                        <div class="overflow-x-auto border-t border-slate-200">
                            <table class="min-w-full">
                                <thead class="bg-slate-50"><tr><th class="py-2 px-6 text-left">File & Status</th><th class="py-2 px-6 text-left">Progress</th></tr></thead>
                                <tbody class="bg-white divide-y divide-slate-200">
                                    <template x-for="dl in activeDownloads" :key="dl.id">
                                        <tr>
                                            <td class="py-3 px-6"><p class="text-sm font-mono" x-text="dl.filename"></p></td>
                                            <td class="py-3 px-6">
                                                <div class="w-full bg-slate-200 rounded-full h-2.5">
                                                    <div class="bg-purple-600 h-2.5 rounded-full" :style="{width: (dl.progress / (dl.total || 1) * 100) + '%'}"></div>
                                                </div>
                                                <p class="text-xs text-slate-500 text-right mt-1">
                                                    <span x-text="formatProgress(dl)"></span>
                                                    <span x-show="dl.unit === 'bytes' && dl.speed_bps > 0" class="font-medium text-purple-600" x-text="`(${formatSpeed(dl.speed_bps)})`"></span>
                                                </p>
                                            </td>
                                        </tr>
                                    </template>
                                    <template x-if="activeDownloads.length === 0"><tr><td colspan="2" class="py-8 px-6 text-center text-sm">The box is quiet... for now.</td></tr></template>
                                </tbody>
                            </table>
                        </div>
                    </section>

                    <!-- Download History Section -->
                    <section class="bg-white shadow-sm ring-1 ring-slate-900/5 rounded-lg">
                        <header class="p-4 sm:px-6"><h2 class="text-lg font-medium leading-6 text-slate-900">Box Contents</h2></header>
                        <div class="overflow-x-auto border-t border-slate-200">
                            <table class="min-w-full">
                                <thead class="bg-slate-50">
                                    <tr>
                                        <th class="py-2 px-6 text-left text-sm font-semibold text-slate-600">File Details</th>
                                        <th class="py-2 px-6 text-left text-sm font-semibold text-slate-600">Size</th>
                                        <th class="py-2 px-6 text-left text-sm font-semibold text-slate-600">Status</th>
                                        <th class="py-2 px-6 text-right text-sm font-semibold text-slate-600">Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-slate-200">
                                    <template x-for="dl in downloads" :key="dl.id">
                                        <tr>
                                            <td class="py-3 px-6">
                                                <div class="flex items-start space-x-4">
                                                    <img :src="dl.thumbnail" x-show="dl.thumbnail" class="h-12 w-20 object-cover rounded-md bg-slate-200 flex-shrink-0" referrerpolicy="no-referrer">
                                                    <div x-show="!dl.thumbnail" class="h-12 w-20 rounded-md bg-slate-200 flex items-center justify-center text-xs text-slate-400 flex-shrink-0">No Thumb</div>
                                                    <div>
                                                        <p class="text-sm font-mono font-medium text-slate-800" x-text="dl.filename"></p>
                                                        <p class="text-xs text-slate-500 mt-0.5">
                                                            <a :href="dl.source_url" x-show="dl.source_url" target="_blank" class="text-purple-600 hover:underline" x-text="dl.source_url ? (dl.source_url.startsWith('search:') ? dl.source_url : new URL(dl.source_url).hostname) : ''"></a>
                                                            <span x-show="dl.duration" x-text="` | ${formatDuration(dl.duration)}`"></span>
                                                        </p>
                                                    </div>
                                                </div>
                                            </td>
                                            <td class="py-3 px-6"><p class="text-sm" x-text="formatBytes(dl.size_bytes)"></p></td>
                                            <td class="py-3 px-6">
                                                <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium" :class="{'bg-green-100 text-green-800': dl.status === 'COMPLETED','bg-red-100 text-red-800': dl.status === 'FAILED', 'bg-yellow-100 text-yellow-800': dl.status === 'CANCELLED'}" x-text="dl.status"></span>
                                            </td>
                                            <td class="py-3 px-6 text-right space-x-4">
                                                <a x-show="dl.status === 'COMPLETED'" :href="`/download/${dl.filename}`" class="font-semibold text-purple-600">Download</a>
                                                <button x-show="dl.status === 'COMPLETED'" @click="renameFile(dl)" class="font-semibold text-blue-600">Rename</button>
                                                <button @click="deleteFile(dl.filename)" class="font-semibold text-red-500">Delete</button>
                                            </td>
                                        </tr>
                                    </template>
                                    <template x-if="downloads.length === 0"><tr><td colspan="4" class="py-8 px-6 text-center text-sm">The box is empty.</td></tr></template>
                                </tbody>
                            </table>
                        </div>
                    </section>
                </div>
            </div>
        </main>
    </div>

    <script>
    function settingsPage() {
        return {
            settings: {
                proxy: '',
                workers: 4,
                retries: 3,
                timeout: 60,
                threading_mode: 'threaded',
                directory_system: false,
                ignore_errors: true
            },
            isSaving: false,
            init() {
                this.loadSettings();
            },
            async loadSettings() {
                try {
                    const response = await fetch("{{ url_for('api.get_pandora_box_settings') }}");
                    if (response.ok) {
                        this.settings = await response.json();
                    } else {
                        this.showAlert('Failed to load settings from porn-fetch service.', true);
                    }
                } catch (e) {
                    this.showAlert('An error occurred while loading settings.', true);
                }
            },
            async saveSettings() {
                this.isSaving = true;
                const csrfToken = document.querySelector('input[name="csrf_token"]').value;
                try {
                    const response = await fetch("{{ url_for('api.get_pandora_box_settings') }}", {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                        body: JSON.stringify(this.settings)
                    });
                    if (response.ok) {
                        this.showAlert('Settings saved successfully.', false);
                    } else {
                        const result = await response.json();
                        this.showAlert(result.error || 'Failed to save settings.', true);
                    }
                } catch (e) {
                    this.showAlert('An error occurred while saving settings.', true);
                } finally {
                    this.isSaving = false;
                }
            }
        }
    }

    function modelManagerPage() {
        return {
            trackedModels: [],
            isLoading: false,
            init() {
                this.loadModels();
                // Listen for global alerts to show messages from other components
                window.addEventListener('show-alert', (event) => {
                    this.$dispatch('show-alert', event.detail);
                });
            },
            async loadModels() {
                this.isLoading = true;
                try {
                    const response = await fetch("{{ url_for('api.manage_pandora_box_models') }}");
                    if (response.ok) {
                        this.trackedModels = await response.json();
                    } else {
                        this.showAlert('Failed to load tracked models.', true);
                    }
                } catch (e) {
                    this.showAlert('An error occurred while loading models.', true);
                } finally {
                    this.isLoading = false;
                }
            },
            async addModel() {
                const urlInput = document.getElementById('new_model_url');
                const url = urlInput.value.trim();
                if (!url) {
                    this.showAlert('Please enter a model URL.', true);
                    return;
                }
                this.isLoading = true;
                const csrfToken = document.querySelector('input[name="csrf_token"]').value;
                try {
                    const response = await fetch("{{ url_for('api.manage_pandora_box_models') }}", {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                        body: JSON.stringify({ url: url })
                    });
                    const result = await response.json();
                    if (response.ok) {
                        this.showAlert(result.message, false);
                        this.trackedModels.push(url);
                        urlInput.value = '';
                    } else {
                        this.showAlert(result.error, true);
                    }
                } catch (e) {
                    this.showAlert('An error occurred while adding the model.', true);
                } finally {
                    this.isLoading = false;
                }
            },
            async removeModel(url) {
                if (!confirm(`Are you sure you want to remove '${url}' from tracking?`)) return;
                this.isLoading = true;
                const csrfToken = document.querySelector('input[name="csrf_token"]').value;
                try {
                    const response = await fetch("{{ url_for('api.manage_pandora_box_models') }}", {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                        body: JSON.stringify({ url: url })
                    });
                    const result = await response.json();
                    if (response.ok) {
                        this.showAlert(result.message, false);
                        this.trackedModels = this.trackedModels.filter(m => m !== url);
                    } else {
                        this.showAlert(result.error, true);
                    }
                } catch (e) {
                    this.showAlert('An error occurred while removing the model.', true);
                } finally {
                    this.isLoading = false;
                }
            },
            async checkAllModelsForUpdates() {
                this.isLoading = true;
                this.showAlert('Checking all tracked models for new videos...', false);
                const csrfToken = document.querySelector('input[name="csrf_token"]').value;
                let allNewVideos = [];
                let checkedCount = 0;

                for (const url of this.trackedModels) {
                    try {
                        const response = await fetch("{{ url_for('api.check_model_updates') }}", {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                            body: JSON.stringify({ url: url })
                        });
                        if (response.ok) {
                            const newVideos = await response.json();
                            if (newVideos.length > 0) {
                                allNewVideos.push(...newVideos);
                            }
                        } else {
                             this.showAlert(`Failed to check for updates for ${url}.`, true);
                        }
                    } catch (e) {
                        this.showAlert(`An error occurred while checking ${url}.`, true);
                    }
                    checkedCount++;
                    this.showAlert(`Checked ${checkedCount} of ${this.trackedModels.length} models...`, false);
                }

                if (allNewVideos.length > 0) {
                    // Use a Set to remove any potential duplicates if models share videos
                    const uniqueVideos = Array.from(new Map(allNewVideos.map(item => [item['url'], item])).values());
                    this.showAlert(`Found a total of ${uniqueVideos.length} new videos. They have been added to the 'Fetched Videos' list.`, false);
                    window.dispatchEvent(new CustomEvent('new-videos-found', { detail: uniqueVideos }));
                } else {
                    this.showAlert('No new videos found across all tracked models.', false);
                }
                this.isLoading = false;
            },
            async checkForUpdates(url) {
                this.isLoading = true;
                this.showAlert(`Checking for new videos from ${url}...`, false);
                const csrfToken = document.querySelector('input[name="csrf_token"]').value;
                try {
                    const response = await fetch("{{ url_for('api.check_model_updates') }}", {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                        body: JSON.stringify({ url: url })
                    });
                    const newVideos = await response.json();
                    if (response.ok) {
                        if (newVideos.length > 0) {
                            this.showAlert(`Found ${newVideos.length} new videos. They have been added to the 'Fetched Videos' list.`, false);
                            // Dispatch an event with the new videos for the main component to handle
                            window.dispatchEvent(new CustomEvent('new-videos-found', { detail: newVideos }));
                        } else {
                            this.showAlert('No new videos found for this model.', false);
                        }
                    } else {
                        this.showAlert(newVideos.error || 'Failed to check for updates.', true);
                    }
                } catch (e) {
                    this.showAlert('An error occurred while checking for updates.', true);
                } finally {
                    this.isLoading = false;
                }
            },
            showAlert(message, isError) {
                // Dispatch a global alert event that the main component can catch and display
                window.dispatchEvent(new CustomEvent('show-alert', { detail: { message, isError } }));
            },

            // New function to detect provider from URL
            detectProvider(url) {
                if (!url) return null;
                const hostname = new URL(url).hostname.toLowerCase();
                if (hostname.includes('pornhub')) return 'pornhub';
                if (hostname.includes('xvideos')) return 'xvideos';
                if (hostname.includes('xnxx')) return 'xnxx';
                if (hostname.includes('eporner')) return 'eporner';
                if (hostname.includes('hqporner')) return 'hqporner';
                if (hostname.includes('missav')) return 'missav';
                if (hostname.includes('xhamster')) return 'xhamster';
                if (hostname.includes('spankbang')) return 'spankbang';
                if (hostname.includes('youporn')) return 'youporn';
                return 'unknown';
            },

            // New function to get quality options based on provider
            getQualityOptions(provider) {
                const options = {
                    'pornhub': ['best', '1080p', '720p', '480p', '360p'],
                    'xvideos': ['best', '1080p', '720p', '480p', '360p'],
                    'xnxx': ['best', '1080p', '720p', '480p', '360p'],
                    'eporner': ['best', 'half', 'worst'],
                    'hqporner': ['best', '1080p', '720p', '480p'],
                    'missav': ['best', '1080p', '720p', '480p'],
                    'xhamster': ['best', '1080p', '720p', '480p'],
                    'spankbang': ['best', '1080p', '720p', '480p'],
                    'youporn': ['best', '1080p', '720p', '480p'],
                    'unknown': ['best']
                };
                return options[provider] || ['best'];
            },

            // Update batch qualities to be dynamic
            updateBatchQualities() {
                const allQualities = new Set(['best']);
                this.fetchedVideos.forEach(video => {
                    if (video.qualities && Array.isArray(video.qualities)) {
                        video.qualities.forEach(q => allQualities.add(q));
                    }
                });
                // Sort them logically: 'best' first, then numerically descending
                const sorted = Array.from(allQualities).sort((a, b) => {
                    if (a === 'best') return -1;
                    if (b === 'best') return 1;
                    const numA = parseInt(a.replace(/[p best half worst]/g, '')) || 0;
                    const numB = parseInt(b.replace(/[p best half worst]/g, '')) || 0;
                    return numB - numA;
                });
                this.batchQualities = sorted;
            }
        }
    }

    function pornFetchPage() {
        return {
            downloads: JSON.parse(`{{ download_history | tojson | safe }}`),
            activeDownloads: [],
            _lastActiveDownloadCount: 0,
            fetchedVideos: [],
            selectedVideos: [],
            videoInfo: null, // Holds the fetched video metadata for the interactive form
            batchQualities: ['best'],
            isLoading: false,
            isSaving: false,
            init() {
                this.fetchStatus();
                setInterval(() => this.fetchStatus(), 3000); // Refresh progress every 3 seconds

                // Listen for new videos found by the model manager
                window.addEventListener('new-videos-found', (event) => {
                    this.fetchedVideos = [...event.detail, ...this.fetchedVideos];
                    this.updateBatchQualities();
                });

                // Listen for global alerts
                window.addEventListener('show-alert', (event) => {
                    this.showAlert(event.detail.message, event.detail.isError);
                });
            },
            async getVideoInfo() {
                this.isLoading = true;
                this.videoInfo = null;
                const url = document.getElementById('interactive_query_url').value;
                if (!url) {
                    this.showAlert('Please enter a video URL.', true);
                    this.isLoading = false;
                    return;
                }

                const csrfToken = document.querySelector('input[name="csrf_token"]').value;
                try {
                    const response = await fetch("{{ url_for('api.pandora_box_video_info') }}", {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                        body: JSON.stringify({ url: url })
                    });
                    const result = await response.json();
                    if (response.ok) {
                        this.videoInfo = result;
                        this.videoInfo.url = url; // Add the original URL to the info object
                        this.videoInfo.provider = this.detectProvider(url); // Detect provider for quality options
                        
                        // If no qualities returned, use provider defaults
                        if (!this.videoInfo.qualities || this.videoInfo.qualities.length === 0) {
                            this.videoInfo.qualities = this.getDefaultQualityOptions(this.videoInfo.provider);
                            this.showAlert(`No qualities detected for this provider (${this.videoInfo.provider}). Using defaults.`, true);
                        }
                    } else {
                        this.showAlert(result.error || 'Failed to fetch video info.', true);
                    }
                } catch (e) {
                    this.showAlert('An error occurred while fetching video info.', true);
                } finally {
                    this.isLoading = false;
                }
            },
            clearVideoInfo() {
                this.videoInfo = null;
                const urlInput = document.getElementById('interactive_query_url');
                if (urlInput) urlInput.value = '';
            },
            async fetchStatus() {
                try {
                    const response = await fetch('/api/pandora-box/status');
                    if(response.ok) {
                        const newDownloads = await response.json();
                        // If a download has finished, refresh the history
                        if (newDownloads.length < this._lastActiveDownloadCount) {
                            this.fetchHistory();
                        }
                        this.activeDownloads = newDownloads;
                        this._lastActiveDownloadCount = newDownloads.length;
                    }
                } catch (e) { console.error("Failed to fetch porn-fetch status", e); }
            },
            async fetchHistory() {
                try {
                    const response = await fetch('/api/pandora-box/history');
                    if (response.ok) {
                        this.downloads = await response.json();
                    }
                } catch (e) {
                    console.error("Failed to fetch porn-fetch history", e);
                    this.showAlert('Could not refresh download history.', true);
                }
            },
            async fetchAndDownloadAll(type) {
                this.isLoading = true;
                this.fetchedVideos = [];
                this.selectedVideos = [];
                this.showAlert(`Fetching all videos for ${type}...`, false);

                const payload = this.buildFetchPayload(type);
                if (!payload) {
                    this.isLoading = false;
                    return;
                }

                const csrfToken = document.querySelector('input[name="csrf_token"]').value;
                try {
                    const response = await fetch("{{ url_for('api.fetch_videos') }}", {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const videos = await response.json();
                        if (videos.length > 0) {
                            this.showAlert(`Found ${videos.length} videos. Now sending to downloader...`, false);
                            const urls = videos.map(v => v.url);
                            // We create a temporary, hidden select element to pass the quality value
                            const qualitySelect = document.createElement('select');
                            qualitySelect.id = 'temp_quality_for_fetch_all';
                            qualitySelect.innerHTML = `<option value="best" selected>Best</option>`;
                            qualitySelect.style.display = 'none';
                            document.body.appendChild(qualitySelect);
                            await this.submitBatchDownload(urls, qualitySelect.id);
                            document.body.removeChild(qualitySelect);
                        } else {
                            this.showAlert('No videos found for this URL.', false);
                        }
                    } else {
                        const result = await response.json();
                        this.showAlert(result.error || `Failed to fetch videos for ${type}.`, true);
                    }
                } catch (e) {
                    this.showAlert(`An error occurred while fetching videos for ${type}.`, true);
                    console.error(e);
                } finally {
                    this.isLoading = false;
                }
            },

            buildFetchPayload(type) {
                const query = document.getElementById(`query_${type}`).value?.trim();
                if (!query) {
                    this.showAlert('Query field cannot be empty.', true);
                    return null;
                }
                const payload = {
                    type: type,
                    query: query,
                    limit: document.getElementById(`limit_${type}`).value,
                    delay: document.getElementById(`delay_${type}`).value
                };
                if (type === 'search') {
                    payload.providers = Array.from(document.querySelectorAll('input[name="providers"]:checked')).map(el => el.value);
                    if (payload.providers.length === 0) {
                        this.showAlert('Please select at least one search provider.', true);
                        return null;
                    }
                }
                return payload;
            },

            async fetchVideos(type) {
                this.isLoading = true;
                this.fetchedVideos = [];
                this.selectedVideos = [];

                const query = document.getElementById(`query_${type}`).value?.trim();
                if (!query) {
                    this.showAlert('Query field cannot be empty.', true);
                    this.isLoading = false;
                    return;
                }

                const csrfToken = document.querySelector('input[name="csrf_token"]').value;
                const payload = {
                    type: type,
                    query: query,
                    limit: document.getElementById(`limit_${type}`).value,
                    delay: document.getElementById(`delay_${type}`).value
                };

                if (type === 'search') {
                    payload.providers = Array.from(document.querySelectorAll('input[name="providers"]:checked')).map(el => el.value);
                    if (payload.providers.length === 0) {
                        this.showAlert('Please select at least one search provider.', true);
                        this.isLoading = false;
                        return;
                    }
                }

                try {
                    const response = await fetch("{{ url_for('api.fetch_videos') }}", {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const resultText = await response.text();
                        const videos = JSON.parse(resultText); // The backend now streams a raw JSON array
                        this.fetchedVideos = videos;
                        this.updateBatchQualities();
                        if (this.fetchedVideos.length === 0) {
                            this.showAlert('No videos found for this URL.', false);
                        }
                    } else {
                        const result = await response.json(); // Error responses are not streamed
                        this.showAlert(result.error || 'Failed to fetch videos.', true);
                    }
                } catch (e) {
                    this.showAlert('An error occurred while fetching videos.', true);
                    console.error(e);
                } finally {
                    this.isLoading = false;
                }
            },
            updateBatchQualities() {
                const allQualities = new Set(['best']);
                this.fetchedVideos.forEach(video => {
                    if (video.qualities && Array.isArray(video.qualities)) {
                        video.qualities.forEach(q => allQualities.add(q));
                    }
                });
                // Sort them logically: 'best' first, then numerically descending
                const sorted = Array.from(allQualities).sort((a, b) => {
                    if (a === 'best') return -1;
                    if (b === 'best') return 1;
                    const numA = parseInt(a.replace('p', '')) || 0;
                    const numB = parseInt(b.replace('p', '')) || 0;
                    return numB - numA;
                });
                this.batchQualities = sorted;
            },
            toggleSelectAll(checked) {
                if (checked) {
                    this.selectedVideos = this.fetchedVideos.map(v => v.url);
                } else {
                    this.selectedVideos = [];
                }
            },
            clearFetchedVideos() {
                this.fetchedVideos = [];
                this.selectedVideos = [];
                this.batchQualities = ['best'];
            },
            showAlert(message, isError = false) {
                const el = document.createElement('div');
                el.textContent = message;
                el.className = `fixed top-5 right-5 p-4 rounded-lg shadow-lg text-white text-sm z-50 ${isError ? 'bg-red-500' : 'bg-green-600'}`;
                document.body.appendChild(el);
                setTimeout(() => el.remove(), 4000);
            },
            async renameFile(download) {
                const newFilename = prompt(`Enter new filename for '${download.filename}':`, download.filename);
                if (newFilename && newFilename !== download.filename) {
                    const csrfToken = document.querySelector('input[name="csrf_token"]').value;
                    const r = await fetch(`/api/files/${download.filename}/rename`, {
                        method: "POST", headers: { "Content-Type": "application/json", "X-CSRFToken": csrfToken },
                        body: JSON.stringify({ new_filename: newFilename })
                    });
                    const result = await r.json();
                    if (r.ok) {
                        this.showAlert(`'${download.filename}' renamed to '${result.new_filename}'.`);
                        download.filename = result.new_filename;
                    } else { this.showAlert(result.error || 'Failed to rename file.', true); }
                }
            },
            async submitBatchDownload(urls, qualityElementId) {
                this.isSaving = true;
                const cleanedUrls = urls.map(u => u.trim()).filter(u => u);
                if (cleanedUrls.length === 0) {
                    this.showAlert('You must provide at least one URL.', true);
                    this.isSaving = false;
                    return;
                }

                const quality = document.getElementById(qualityElementId).value;
                const csrfToken = document.querySelector('input[name="csrf_token"]').value;

                try {
                    const response = await fetch("{{ url_for('api.pandora_box_batch_download') }}", {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                        body: JSON.stringify({ urls: cleanedUrls, quality: quality })
                    });
                    const result = await response.json();
                    if (response.ok || response.status === 207) {
                        let message = `Successfully requested batch download of ${cleanedUrls.length} videos.`;
                        if (result.failed_urls && result.failed_urls.length > 0) {
                            message += ` Failed: ${result.failed_urls.length} (${result.failed_urls.join(', ')})`;
                            this.showAlert(message, true);  // Show as error for partial failure
                        } else {
                            this.showAlert(message, false);
                        }
                        this.fetchStatus(); // Immediately poll for status to provide instant feedback

                        // If the download was initiated from the fetched videos list, clear it for a cleaner UI.
                        if (this.fetchedVideos.length > 0) {
                             this.clearFetchedVideos();
                        }

                        // If the download was initiated from the single video panel, reset it
                        if (this.videoInfo !== null && cleanedUrls.length === 1 && this.videoInfo.url === cleanedUrls[0]) {
                            this.clearVideoInfo();
                        }

                        // If the download was initiated from the file/textarea panel, reset it
                        const urlListInput = document.getElementById('url_list');
                        if (urlListInput) {
                            urlListInput.value = '';
                        }
                    } else {
                        this.showAlert(result.error || 'Failed to start batch download.', true);
                    }
                } catch (e) {
                    this.showAlert('An error occurred while submitting the batch download.', true);
                } finally {
                    this.isSaving = false;
                }
            },
            async deleteFile(filename) {
                if (confirm(`Are you sure you want to delete '${filename}'?`)) {
                    const csrfToken = document.querySelector('input[name="csrf_token"]').value;
                    const r = await fetch(`/api/files/${filename}`, { method: "DELETE", headers: { "X-CSRFToken": csrfToken } });
                    if (r.ok) {
                        this.showAlert(`'${filename}' deleted.`);
                        this.downloads = this.downloads.filter(d => d.filename !== filename);
                    } else { const res = await r.json(); this.showAlert(res.error || 'Failed to delete file.', true); }
                }
            },
            formatProgress(dl) {
                if (dl.unit === 'bytes') {
                    return `${this.formatBytes(dl.progress)} / ${this.formatBytes(dl.total)}`;
                } else {
                    return `${dl.progress} / ${dl.total} segments`;
                }
            },
            formatBytes(b,d=2){if(!+b)return"0 Bytes";const k=1024,i=Math.floor(Math.log(b)/Math.log(k));return`${parseFloat((b/Math.pow(k,i)).toFixed(d))} ${['B','KB','MB','GB','TB'][i]}`},
            formatSpeed(bps){if(!+bps||bps<0)return"0 B/s";const Bps=bps/8,k=1024,s=['B/s','KB/s','MB/s','GB/s','TB/s'];if(Bps===0)return'0 B/s';const i=Math.floor(Math.log(Bps)/Math.log(k));return`${parseFloat((Bps/Math.pow(k,i)).toFixed(2))} ${s[i]}`},
            formatDuration(seconds) {
                if (seconds === null || isNaN(seconds) || seconds <= 0) return '';
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);

                let parts = [];
                if (hours > 0) parts.push(`${hours}h`);
                if (minutes > 0) parts.push(`${minutes}m`);

                if (parts.length > 0) {
                    return parts.join(' ');
                }
                // For durations less than a minute, show seconds
                return `${seconds % 60}s`;
            },
            formatDate(dateString) {
                if (!dateString) return '';
                // Handle 'yesterday' or other relative terms gracefully
                if (isNaN(new Date(dateString))) {
                    return dateString.charAt(0).toUpperCase() + dateString.slice(1);
                }
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
            }
        }
    }
    </script>
</body>
</html>
